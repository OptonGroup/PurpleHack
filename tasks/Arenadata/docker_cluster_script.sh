#!/bin/bash
# Скрипт для запуска кластеризации в Docker с мониторингом памяти

# Остановка и удаление существующего контейнера
echo "Останавливаем существующий контейнер (если есть)..."
docker-compose down

# Пересборка образа с новыми оптимизациями
echo "Пересобираем Docker-образ с оптимизациями памяти..."
docker-compose build

# Запуск контейнера в фоновом режиме
echo "Запускаем контейнер..."
docker-compose up -d

# Ожидание запуска контейнера
echo "Ждем 5 секунд для полного запуска контейнера..."
sleep 5

# Мониторинг использования памяти перед запуском
echo "Текущее использование памяти контейнером:"
docker stats telecomguardian --no-stream

# Запуск скрипта кластеризации с ограничением памяти
echo "Запускаем кластеризацию..."
docker-compose exec telecomguardian python run_cluster_for_result.py

# Проверка результатов
if [ $? -eq 0 ]; then
    echo "Кластеризация успешно завершена!"
    echo "Результаты сохранены в RESULT.csv"
    
    # Мониторинг использования памяти после выполнения
    echo "Использование памяти после кластеризации:"
    docker stats telecomguardian --no-stream
else
    echo "Кластеризация завершилась с ошибкой."
    
    # Просмотр логов для диагностики проблем
    echo "Последние логи контейнера:"
    docker-compose logs telecomguardian --tail 100
fi 