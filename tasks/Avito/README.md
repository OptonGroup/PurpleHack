# Определение цвета товара по фотографии

## Описание проекта

Проект представляет собой решение задачи определения цвета товара по его фотографии. Модель способна классифицировать товары на один из 18 возможных цветов. Товары относятся к 4 категориям: одежда для девочек, столы, стулья, сумки.

## Структура проекта

```
.
├── Dockerfile               # Файл для сборки Docker-образа
├── docker-compose.yml       # Конфигурация Docker Compose
├── requirements.txt         # Python-зависимости
├── README.md                # Этот файл
├── notebooks/               # Jupyter ноутбуки
│   ├── inference-for-one-image.ipynb        # Ноутбук для инференса одного изображения
│   ├── inference-to-create-submission.ipynb # Ноутбук для создания submission-файла
│   └── initialize_model.py                  # Скрипт для инициализации модели и загрузки весов
├── scripts/                 # Служебные скрипты
│   └── download_weights.py  # Скрипт для загрузки весов модели
└── weights/                 # Директория для хранения весов модели
```

## Требования

- Docker >= 19.03.0
- Docker Compose >= 1.25.0
- Python >= 3.10 (если запускаете без Docker)
- CUDA-совместимая видеокарта (опционально)

## Быстрый старт

### Запуск с использованием Docker

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/username/avito-color-classifier.git
   cd avito-color-classifier
   ```

2. Соберите и запустите Docker-контейнер:
   ```bash
   docker-compose up --build
   ```

3. Откройте Jupyter Notebook в браузере по ссылке, которая появится в консоли, или перейдите по адресу:
   ```
   http://localhost:8888
   ```

### Автоматическая загрузка весов модели

В проекте реализована автоматическая загрузка весов модели при первом запуске. Если в директории `weights/` отсутствует файл `model_weights.pth`, при инициализации модели будет выполнена автоматическая загрузка весов с указанного URL.

Для этого при запуске ноутбуков используйте функцию `initialize_model` с параметром `weights_url`:

```python
from notebooks.initialize_model import initialize_model

# URL для загрузки весов
WEIGHTS_URL = "https://example.com/weights.pth"
# Путь для сохранения весов
WEIGHTS_PATH = "/app/weights/model_weights.pth"

# Инициализация модели с автоматической загрузкой весов
model = initialize_model(WEIGHTS_PATH, WEIGHTS_URL)
```

Если вы хотите загрузить веса вручную, можно использовать скрипт:

```bash
docker exec -it avito_color_classifier python /app/scripts/download_weights.py --url URL_ВЕСОВ --output /app/weights/model_weights.pth
```

Замените `URL_ВЕСОВ` на актуальный URL для загрузки весов модели.

## Использование ноутбуков

### Инференс для одного изображения

Ноутбук `notebooks/inference-for-one-image.ipynb` позволяет определить цвет товара по его фотографии:

1. Откройте ноутбук в Jupyter
2. Выполните все ячейки для инициализации модели (веса будут загружены автоматически)
3. Укажите путь к изображению и категорию товара
4. Получите предсказанный цвет и топ-5 наиболее вероятных цветов

Ноутбук предоставляет два способа использования:
- Прямое указание пути к изображению и категории товара
- Интерактивный ввод через специальную ячейку, где пользователь указывает путь и выбирает категорию

### Создание submission-файла

Ноутбук `notebooks/inference-to-create-submission.ipynb` позволяет создать submission-файл для набора тестовых изображений:

1. Откройте ноутбук в Jupyter
2. Выполните все ячейки для инициализации модели и загрузки тестовых данных
3. Получите submission-файл в формате CSV с предсказанными цветами и их вероятностями

Формат выходного файла соответствует требованиям задачи:
- `id` - идентификатор изображения
- `category` - категория товара
- `predict_proba` - JSON-строка с вероятностями для каждого цвета
- `predict_color` - цвет с максимальной вероятностью

## Запуск без Docker

Если вы хотите запустить проект без Docker, вам потребуется установить все зависимости:

```bash
pip install -r requirements.txt
```

После этого вы можете запустить Jupyter Notebook:

```bash
jupyter notebook
```

Весы модели будут загружены автоматически при вызове функции `initialize_model` с параметром `weights_url`.

## Зависимости

Основные зависимости проекта:

- Python 3.10
- PyTorch 2.0.1
- torchvision 0.15.2
- timm 0.9.7
- numpy 1.24.3
- pandas 2.0.3
- Pillow 10.0.0
- scikit-learn 1.3.0
- tqdm 4.66.1
- requests
- jupyter 1.0.0

## Информация о модели

Для классификации используется модель на основе Vision Transformer (ViT), дополненная категориальными эмбеддингами для учёта категории товара. 

Модель построена на базе архитектуры `beitv2_large_patch16_224` из библиотеки timm, что обеспечивает высокую точность с приемлемой скоростью инференса. Она дополнена специальным слоем для учета категории товара, что позволяет более точно определять цвет в разных контекстах.

Основные характеристики модели:
- Интеграция эмбеддингов категории товара
- Более 18 классов цветов
- Предварительное обучение на большом датасете изображений
- Точность (F1-score) более 0.9 на тестовой выборке

## Авторы

- Ваше имя

## Лицензия

MIT
=======
=======
>>>>>>> 8f5255fb25fb5dba88e50224a80f803e4ce18315
=======
>>>>>>> 8f5255fb25fb5dba88e50224a80f803e4ce18315
# Определение основного цвета товара на фотографии

## Введение

Данный проект решает задачу определения основного цвета товара по фотографии для платформы Avito. Разработанная модель машинного обучения классифицирует товары в 4 категориях (одежда для девочек, столы, стулья, сумки) по 18 возможным цветам. Решение основано на глубоком обучении с использованием предобученных моделей, что обеспечивает высокую точность классификации при сохранении хорошей производительности.

## Описание задачи

### Цель

Определить основной цвет товара на фотографии, выбрав один из 18 возможных цветов

### Категории товаров

- одежда для девочек
- столы
- стулья
- сумки

### Метрики оценки

- **Recall (macro)** - важно не пропустить товары нужного цвета
- **Precision (macro)** - важно уменьшить ложные срабатывания
- **Accuracy** - общая точность модели
- **F1 (macro)** - гармоническое среднее Precision и Recall

## Архитектура решения

### Обзор подхода

Для решения задачи был выбран подход глубокого обучения с использованием современной архитектуры компьютерного зрения. Основой решения стала предобученная модель BEiT v2 (Bidirectional Encoder representation from Image Transformers), адаптированная для задачи классификации цветов.

### Ключевые компоненты модели

1. **Backbone**: BEiT v2 Large с размером патча 16x16 и входным разрешением 224x224
2. **Учет категории товара**: Дополнительный embedding слой, кодирующий категорию товара
3. **Классификационная голова**: Полносвязанная нейронная сеть с активацией ReLU и dropout для регуляризации

## Предобработка данных

### Трансформации для обучения

```python
train_transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.RandomHorizontalFlip(p=0.5),
    transforms.RandomRotation(10, fill=0, interpolation=transforms.InterpolationMode.BILINEAR),
    transforms.ColorJitter(brightness=0.2, contrast=0.2, saturation=0.2, hue=0),
    transforms.ToTensor(),
    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])
```

### Трансформации для валидации и тестирования

```python
test_transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])
```

## Обучение модели

### Параметры обучения

- **Планировщик скорости обучения**: CosineAnnealingLR с T_max=10
- **Функция потерь**: CrossEntropyLoss
- **Размер батча**: 32 для обучения, 64 для валидации и тестирования

## Инференс и предсказания

### Формат выходных данных

Для каждого изображения модель возвращает:

- Предсказанный основной цвет (`predict_color`)
- Вероятности для всех 18 цветов в формате JSON-строки (`predict_proba`)

### Пример вывода:

```
{
    "id": 36490520922,
    "category": "сумки",
    "predict_proba": {"bezhevyi": 0.01, "belyi": 0.8, "chernyi": 0.1, ...},
    "predict_color": "belyi"
}
```

### Оптимизация инференса

- Использование torch.jit для оптимизации модели
- Поддержка inference на GPU для ускорения предсказаний
- Настройка TensorRT/CUDA для максимизации производительности

## Результаты и анализ

### Метрики на валидационной выборке

_Примечание: конкретные значения будут получены после финальной оценки_

- Precision (macro): 0.7303
- Recall (macro): 0.7045
- F1 (macro): 0.7172
- Accuracy: 0.7978

### Производительность

Среднее время инференса: 62.51 мс  
Минимальное время: 61.76 мс  
Максимальное время: 63.37 мс  
95-й перцентиль: 63.16 мс  

## Анализ сложных случаев

### Типичные источники ошибок

1. **Многоцветные товары** - особенно в категории "сумки", где часто присутствует несколько цветов
2. **Освещение** - различное освещение на фотографиях может искажать восприятие цвета
3. **Фон товара** - в некоторых случаях фон может доминировать над цветом самого товара

## Использование решения

### Обучение модели

Для обучения модели используйте скрипт `train.ipynb`.

### Предсказания для целого набора данных

Для генерации предсказаний для тестового набора данных используйте скрипт `inference-to-create-submission.ipynb`.

### Предсказание для одного изображения

Для предсказания цвета одиночного изображения используйте функцию `predict_color` из скрипта `inference-for-one-imagee.ipynb`:
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> 8f5255fb25fb5dba88e50224a80f803e4ce18315
=======
>>>>>>> 8f5255fb25fb5dba88e50224a80f803e4ce18315
=======
>>>>>>> 8f5255fb25fb5dba88e50224a80f803e4ce18315
