{% extends "base.html" %}

{% block title %}Результат оптимизации - Оптимизатор календарного плана{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.css" rel="stylesheet">
<style>
    #calendar {
        height: 600px;
        margin: 20px 0;
        background-color: white;
    }
    .fc-event {
        cursor: pointer;
    }
    .fc-daygrid-event {
        white-space: normal;
    }
    .loading-container {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    .loading-text {
        margin-top: 20px;
        font-size: 1.2em;
        color: #666;
    }
    .loading-progress {
        margin-top: 20px;
        height: 4px;
    }
    .loading-tips {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2>Результат оптимизации</h2>
                <div>
                    <a href="/results" class="btn btn-sm btn-light">
                        <i class="bi bi-arrow-left"></i> Назад к результатам
                    </a>
                    {% if status.status == "completed" %}
                    <a href="/api/download/{{ job_id }}" class="btn btn-sm btn-success">
                        <i class="bi bi-download"></i> Скачать JSON
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if status.status == "pending" %}
                <div class="loading-container">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <div class="loading-text">
                        Идет оптимизация расписания...
                    </div>
                    <div class="progress loading-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="loading-tips">
                        <p><strong>Что происходит:</strong></p>
                        <ul class="text-start">
                            <li>Анализ зависимостей между задачами</li>
                            <li>Оптимизация распределения ресурсов</li>
                            <li>Минимизация общей длительности проекта</li>
                            <li>Балансировка нагрузки на ресурсы</li>
                        </ul>
                        <p class="mb-0"><small>Это может занять несколько минут. Пожалуйста, не закрывайте страницу.</small></p>
                    </div>
                </div>
                {% elif status.status == "completed" and result %}
                <div class="mt-4">
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view" type="button" role="tab">
                                <i class="bi bi-calendar3"></i> Календарь
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-view" type="button" role="tab">
                                <i class="bi bi-table"></i> Таблица
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="resultTabsContent">
                        <div class="tab-pane fade show active" id="calendar-view" role="tabpanel">
                            <div id="calendar"></div>
                        </div>
                        <div class="tab-pane fade" id="table-view" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID задачи</th>
                                            <th>Дата начала</th>
                                            <th>Дата окончания</th>
                                            <th>Ресурс</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for task in result.tasks %}
                                        <tr>
                                            <td>{{ task.id }}</td>
                                            <td>{{ task.startDate or task.start_date }}</td>
                                            <td>{{ task.endDate or task.end_date }}</td>
                                            <td>{{ task.assignedResourceId or task.resource }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif status.status == "failed" %}
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-2"></i> Произошла ошибка при оптимизации
                    {% if status.error %}
                    <hr>
                    <p class="mb-0">{{ status.error }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/locales/ru.js"></script>
<script>
    function getTaskColor(resourceId) {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
            '#D4A5A5', '#9B59B6', '#3498DB', '#1ABC9C', '#F1C40F'
        ];
        let hash = 0;
        for (let i = 0; i < resourceId.toString().length; i++) {
            hash = ((hash << 5) - hash) + resourceId.toString().charCodeAt(i);
            hash = hash & hash;
        }
        return colors[Math.abs(hash) % colors.length];
    }

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const status = {{ status|tojson|safe }};
        const result = {{ result|default({})|tojson|safe }};
        
        if (calendarEl && status && status.status === "completed" && result && result.tasks) {
            const tasks = result.tasks;
            if (Array.isArray(tasks) && tasks.length > 0) {
                const events = tasks.map(task => {
                    const resourceId = task.assignedResourceId || task.resource || 'Не назначен';
                    const color = getTaskColor(resourceId);
                    return {
                        id: task.id,
                        title: `Задача ${task.id} (${resourceId})`,
                        start: task.startDate || task.start_date,
                        end: task.endDate || task.end_date,
                        backgroundColor: color,
                        borderColor: color,
                        textColor: '#000',
                        allDay: true
                    };
                });

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    locale: 'ru',
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth'
                    },
                    events: events,
                    displayEventTime: false,
                    eventDisplay: 'block',
                    eventClick: function(info) {
                        const task = tasks.find(t => t.id === info.event.id);
                        if (task) {
                            alert(
                                `Задача: ${task.id}\n` +
                                `Ресурс: ${task.assignedResourceId || task.resource || 'Не назначен'}\n` +
                                `Начало: ${task.startDate || task.start_date}\n` +
                                `Окончание: ${task.endDate || task.end_date}`
                            );
                        }
                    }
                });

                calendar.render();
            } else {
                calendarEl.innerHTML = '<div class="alert alert-info">Нет задач для отображения</div>';
            }
        }

        if (status && status.status === "pending") {
            function updateStatus() {
                fetch('/api/status/{{ job_id }}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== "pending") {
                            window.location.reload();
                        }
                    })
                    .catch(error => console.error('Ошибка при проверке статуса:', error));
            }
            setInterval(updateStatus, 5000);
        }
    });
</script>
{% endblock %} 